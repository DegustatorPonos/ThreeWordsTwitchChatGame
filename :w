import http from "node:http";
import querystring from "node:querystring";

export function PrintAuthLink() {
    console.log(getAuthLink());
}

export async function Connect(req, res) {
    console.log(req.query);
    res.write("thanks");
    var code = await exchangeCode(req.query.code);
    console.log(code);
}

function getAuthLink() {
    return "https://id.twitch.tv/oauth2/authorize"+
        "?response_type=code"+
        `&client_id=${process.env.TWITCH_API_KEY}`+
        "&redirect_uri=http://localhost:3000/auth"+
        "&scope=user:read:chat+moderator:read:chatters"
}

async function exchangeCode(userCode) {
    var body = new URLSearchParams({
        client_id: process.env.TWITCH_API_KEY,
        client_secret: process.env.TWITCH_API_SECRET,
        code: userCode,
		grant_type: "authorization_code",
		redirect_uri: "http://localhost:3000/auth",
    }).toString();
    console.log(body);
    await fetch("https://id.twitch.tv/oauth2/token", {
        method: "POST",
        body: body,
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
        },
    }).then(async resp =>  {
        await resp.text().then(json => {
            console.log(json);
            return json;
        })
    })
}
